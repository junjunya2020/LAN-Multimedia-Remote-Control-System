<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’­æ”¾æ­·å²è¨˜éŒ„</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .history-container {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .history-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        
        .history-count {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .history-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            color: #333;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .history-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .history-item:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .history-item.current {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .history-item-info {
            flex: 1;
        }
        
        .history-item-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
            color: #333;
        }
        
        .history-item-meta {
            font-size: 12px;
            color: #666;
        }
        
        .history-item-play {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        
        .history-item-play:hover {
            background: #5a6fd8;
        }
        
        .empty-history {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        
        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #218838;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .history-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .history-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .history-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .history-list::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="history-container">
        <div class="history-header">
            <div>
                <h1 class="history-title">æ’­æ”¾æ­·å²è¨˜éŒ„</h1>
                <div class="history-count" id="historyCount">æ­£åœ¨è¼‰å…¥...</div>
            </div>
            <div>
                <button class="refresh-btn" onclick="loadPlaybackHistory()">ğŸ”„ åˆ·æ–°</button>
                <button class="close-btn" onclick="window.close()">âœ• é—œé–‰</button>
            </div>
        </div>
        
        <div class="history-list" id="historyList">
            <div class="loading">æ­£åœ¨è¼‰å…¥æ­·å²è¨˜éŒ„...</div>
        </div>
    </div>

    <script>
        let currentHistory = [];
        
        // è¼‰å…¥æ’­æ”¾æ­·å²è¨˜éŒ„
        async function loadPlaybackHistory() {
            try {
                const response = await fetch('/api/playback_history');
                const result = await response.json();
                
                if (result.status === 'success') {
                    currentHistory = result.playback_history || [];
                    displayHistory(currentHistory);
                } else {
                    throw new Error(result.message || 'ç²å–æ­·å²è¨˜éŒ„å¤±æ•—');
                }
            } catch (error) {
                console.error('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—:', error);
                document.getElementById('historyList').innerHTML = 
                    `<div class="empty-history">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
            }
        }
        
        // é¡¯ç¤ºæ­·å²è¨˜éŒ„
        function displayHistory(history) {
            const historyList = document.getElementById('historyList');
            const historyCount = document.getElementById('historyCount');
            
            historyCount.textContent = `å…± ${history.length} æ¢è¨˜éŒ„`;
            
            if (history.length === 0) {
                historyList.innerHTML = '<div class="empty-history">æš«ç„¡æ’­æ”¾æ­·å²è¨˜éŒ„</div>';
                return;
            }
            
            let html = '';
            history.forEach((item, index) => {
                // è™•ç†å…©ç¨®æ•¸æ“šçµæ§‹ï¼šå­—ç¬¦ä¸²è·¯å¾‘æˆ–å°è±¡
                let path, title, artist, album, playTime, isCurrent;
                
                if (typeof item === 'string') {
                    // ç›´æ¥æ˜¯æ–‡ä»¶è·¯å¾‘å­—ç¬¦ä¸²
                    path = item;
                    title = '';
                    artist = '';
                    album = '';
                    playTime = '';
                    isCurrent = false;
                } else {
                    // å°è±¡çµæ§‹
                    path = item.path || item;
                    title = item.title || item.name || '';
                    artist = item.artist || '';
                    album = item.album || '';
                    playTime = item.play_time ? new Date(item.play_time).toLocaleString() : '';
                    isCurrent = item.is_current || false;
                }
                
                // å¾æ–‡ä»¶è·¯å¾‘æå–æª”æ¡ˆåä½œç‚ºæ¨™é¡Œ
                let displayTitle;
                if (title && title.trim() !== '' && !title.includes('æœªçŸ¥') && title !== 'Unknown Title') {
                    displayTitle = title;
                } else if (path) {
                    // å¾æª”æ¡ˆè·¯å¾‘æå–æª”æ¡ˆå
                    displayTitle = path.split('/').pop().split('\\').pop();
                } else {
                    displayTitle = 'æœªçŸ¥æª”æ¡ˆ';
                }
                
                html += `
                    <div class="history-item ${isCurrent ? 'current' : ''}" onclick="playHistoryItem(${index})">
                        <div class="history-item-info">
                            <div class="history-item-title">${displayTitle}</div>
                            <div class="history-item-meta">
                                ${artist ? `æ­Œæ‰‹: ${artist} | ` : ''}${album ? `å°ˆè¼¯: ${album} | ` : ''}${playTime ? `æ’­æ”¾æ™‚é–“: ${playTime}` : ''}
                            </div>
                        </div>
                        <button class="history-item-play" onclick="event.stopPropagation(); playHistoryItem(${index})">
                            â–¶ï¸ æ’­æ”¾
                        </button>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }
        
        // æ’­æ”¾æ­·å²è¨˜éŒ„ä¸­çš„é …ç›®
        async function playHistoryItem(index) {
            try {
                const item = currentHistory[index];
                
                // è™•ç†å…©ç¨®æ•¸æ“šçµæ§‹ï¼šå­—ç¬¦ä¸²è·¯å¾‘æˆ–å°è±¡
                let filePath;
                if (typeof item === 'string') {
                    filePath = item; // ç›´æ¥æ˜¯æ–‡ä»¶è·¯å¾‘å­—ç¬¦ä¸²
                } else {
                    filePath = item.path || item; // å°è±¡çµæ§‹
                }
                
                if (!filePath) {
                    alert('ç„¡æ³•æ’­æ”¾æ­¤é …ç›®ï¼šç¼ºå°‘æª”æ¡ˆè·¯å¾‘');
                    return;
                }
                
                console.log('æ’­æ”¾æ–‡ä»¶è·¯å¾‘:', filePath);
                
                // èª¿ç”¨çˆ¶è¦–çª—çš„æ’­æ”¾å‡½æ•¸ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                // ç›´æ¥èª¿ç”¨ API
                const response = await fetch(`/api/set_file?file=${encodeURIComponent(filePath)}`);
                const result = await response.json();
                
                if (result.status === 'loaded') {
                    setTimeout(() => window.close(), 3000);
                } else {
                    alert('æ’­æ”¾å¤±æ•—: ' + result.message);
                }
            } catch (error) {
                console.error('æ’­æ”¾æ­·å²é …ç›®å¤±æ•—:', error);
                alert('æ’­æ”¾å¤±æ•—: ' + error.message);
            }
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥æ­·å²è¨˜éŒ„
        document.addEventListener('DOMContentLoaded', function() {
            loadPlaybackHistory();
            
            // æ¯30ç§’è‡ªå‹•åˆ·æ–°ä¸€æ¬¡
            setInterval(loadPlaybackHistory, 30000);
        });
        
        // å¿«æ·éµæ”¯æ´
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                window.close();
            } else if (e.key === 'F5') {
                e.preventDefault();
                loadPlaybackHistory();
            }
        });
    </script>
</body>
</html>